% Testing Chapter

Three case studies were performed. The case studies build an arch from
studying how current state of the art installation system works
towards testing the promise of secudep to making installation system a
more secure system to achieve operating system installation.

The first case study looks into an already existing installation
system to verify what protocols are used in the process. This is done
to verify what is written in the introduction chapter about the
current state of the art.

Next case study compares results from the first case study with the
implementation details of secudep. The purpose is to compare how
already existing installation system differs from secudep.

Third and last case study looks into secudep's promise to make
installation system more secure. This is done by simulating the attack
scenarios, for example Man-in-the-Middle attack, and observing how
secudep behaves.


\section{Case Study 1: Identify Protocols}
\label{sec:casestudy1}

\subsection{What was studied}

The purpose of this case study is to identify network protocols used
in online installation system system. This study also verifies the
involved protocols which were described in the introduction chapter.

For installation system a service called
boot.foo.sh~\cite{boot-foo-sh} is used. Boot.foo.sh was chosen because
it's open service known to be used to automatic installations in
enterprises and it has been an inspiration to this thesis to make
installation system more safer to use.

Boot.foo.sh is used to install CentOS~7 Linux operating system. CentOS
Linux is community driven effort to provide free alternative to Red
Hat Enterprise Linux (RHEL). CentOS is built using RHEL source
code. Red Hat has 67 \% market share of Linux distribution market
according to Gartner's analysis~\cite{gartner-redhat}.

\subsection{How it was done}

The installation was done using virtual machine. VirtualBox was chosen
as a virtualization software because it's free, open source and has
easy to use network traffic recording functionality.

\begin{figure}[h]
  \includegraphics[width=\textwidth]{network-recording.pdf}
  \caption{Network traffic recording setup.\label{fig:network-recording}}
\end{figure}

With VirtualBox's network traffic recording it's possible to get
network traffic captured for the whole lifetime of virtual
machine. The capture is saved as standard PCAP file which can later be
opened in network protocol analyzer for
investigation. Figure~\ref{fig:network-recording} has the typical
traffic capturing setup with computer using the installation
system, another computer recording the traffic, network switch
to arrange traffic flows and the Internet containing the installation
system in use.

Traffic capture was then analyzed using Wireshark network protocol
analyzer. Wireshark is free and open source network protocol analyzer
which has capability to help expert user analyze many different
network protocols and their internals.

Traffic analysis was done by hand looking the captured traffic
recording and identifying protocols used.

\subsection{Results found}

Traffic recording was 788 megabytes of network traffic containing over
883 thousand network packets. Recording contains time span of a bit
over nine minutes.

\begin{table}[!ht]
  % Add some padding to the table cells:
  \def\arraystretch{1.1}%
  \begin{center}
    \begin{tabular}{| l | l |}
      \hline
      Step               & Protocol    \\
      \hline
      Address resolution & DHCP        \\
      Name resolution    & DNS         \\
      Boot menu          & HTTPS       \\
      Kernel and initrd  & HTTP        \\
      Kickstart          & HTTP        \\
      Installation files & HTTP (DS)   \\
      \hline
    \end{tabular}
    \caption{Table of found protocols and their role. DS in table
      means Digital Signatures.\label{tab:found_protocols_table}}
  \end{center}
\end{table}

Summary of the protocols used in various steps of installation process
can be found from Table~\ref{tab:found_protocols_table}.

Steps are identified and named for each system used to achieve the
installation. The steps are discussed in chronological order of
appearance as found from traffic recording.

\subsection{Analysis of results}

``Address resolution'' is the first step and it's purpose is to get IP
address and DNS server addresses for system to be installed. DHCP is
the standard protocol for this, and was also found to be used here.

``Name resolution'' is used to translate host names into IP address to
communicate with other servers. DNS protocol is used for name
resolution needs.

\begin{figure}[h]
  \includegraphics[width=\textwidth]{bootfoosh-bootmenu.png}
  \caption{boot.foo.sh boot menu showing selection of operating
    systems.\label{fig:bootmenu}}
\end{figure}

``Boot menu'' is used to display choices of operating systems to be
installed. Boot menu from boot.foo.sh can be seen in
figure~\ref{fig:bootmenu}. Boot.foo.sh uses HTTP protocol to fetch
various files needed to display the boot menu.

``Kernel and initrd'' are the files needed to launch Linux
installation. These two files are downloaded over the Internet and
then kernel is executed and it continues the boot process. HTTP was
used to communicate with CentOS 7 mirror to fetch the needed files.

``Kickstart'' is CentOS specific file for automating unattended
installation. It's set of instructions downloaded and executed by the
installation process. Kickstart file is downloaded by software inside
initrd system so at this point the control of installation is already
switched to CentOS' installer. HTTP was used to communicate with
boot.foo.sh server to fetch the kickstart file.

``Installation files'' are the contents of operating system to be
installed. The files are downloaded and extracted to hard drive to
achieve the installation. Operating system installer is usually
trusted to verify digital signatures (e.g. CentOS uses
OpenPGP~\cite{RFC4880} (``GPG'') signatures) the downloaded content
before extracting the files into hard drive. The CentOS
documentation~\cite{centos-gpg} states that

\begin{quote}
``Each stable RPM package that is published by CentOS Project is signed
with a GPG signature. By default, yum and the graphical update tools
will verify these signatures and refuse to install any packages that
are not signed, or have an incorrect signature. You should always
verify the signature of a package prior to installation. These
signatures ensure that the packages you install are what was produced
by the CentOS Project and have not been altered by any mirror or
web site providing the packages.''
\end{quote}

However, when initrd file is downloaded over insecure protocol or file
content is not verified against signature it's possible for malicious
third party to inject it's own OpenPGP keys into initrd and point
installation system to malicious host serving the operating system
installation files and thus gain full control of the installed system.


\section{Case Study 2: Comparing boot.foo.sh and secudep}
\label{sec:casestudy2}

\subsection{What was studied}

This case study compares implementation details of secudep to already
existing installation system solution which was studied in
case study 1. The purpose of this is to see the differences between
used network protocols between these two systems.

\subsection{How it was done}

The results from case study 1 was used as a base and then
implementation details about secudep were compared against the base.

\subsection{Results found}

\begin{table}[!ht]
  % Add some padding to the table cells:
  \def\arraystretch{1.1}%
  \begin{center}
    \begin{tabular}{| l | l | l |}
      \hline
      Step               & boot.foo.sh   & secudep    \\
      \hline
      Address resolution & DHCP          & DHCP       \\
      Name resolution    & DNS           & DNS        \\
      Boot menu          & HTTP          & HTTPS (DS) \\
      Digital signatures & N/A           & HTTPS      \\
      Kernel and initrd  & HTTP          & HTTP (DS)  \\
      Kickstart          & HTTP          & HTTPS      \\
      Installation files & HTTP (DS)     & HTTP (DS)  \\
      \hline
    \end{tabular}
    \caption{Comparison between how boot.foo.sh and secudep use of
      protocols. DS in table means Digital
      Signatures.\label{tab:comparison_table}}
  \end{center}
\end{table}

Results of comparing boot.foo.sh and secudep can be found from
Table~\ref{tab:comparison_table}. Boot.foo.sh results are same as in
case study 1. The differences between boot.foo.sh and secudep are
discussed next.


\subsection{Analysis of results}

Address and name resolution are identical in both systems. As
discussed in introduction chapter these protocols are standards and
difficult to change.

''Boot menu'' is used to display choices of operating systems to be
installed. HTTP is used in boot.foo.sh and is susceptible to
Man-in-the-Middle attack. Secudep uses HTTPS (HTTP over TLS) with
signed files to remediate this issue.

Secudep uses digital signatures and the signature files are fetched
over HTTPS.\@ This is a step missing from boot.foo.sh.

Kernel and initrd are the files needed to launch the Linux
installation. Both boot.foo.sh and secudep systems use HTTP
protocol. Again HTTP is susceptible to Man-in-the-Middle attacks. HTTP
is used because the files are fetched from CentOS's official mirror
over the internet. Secudep uses digital signatures to verify
downloaded content. After kernel and initrd are downloaded and digital
signatures are verified the execution is handled to kernel. This means
that secudep can't provide digital signatures to any following files.


\section{Case Study 3: Testing attacks against secudep}
\label{sec:casestudy3}

\subsection{What was studied}

This case study consist of simulated attacks against implementation of
secudep. Secudep's main defense against attacks is the use of
encryption (TLS) and digital signatures.

Table~\ref{tab:comparison_table} on
page~\pageref{tab:comparison_table} contains list of protocols
involved in operating system installation process.

The first two protocols, DHCP for address resolution and DNS for name
resolution are insecure and susceptible for example to
Man-in-the-Middle attacks. Loading the boot menu over HTTPS with
digital signature check should validate that DHCP and DNS are not
tampered with and installation can proceed further.

After boot menu step is done, secudep loads kernel and initrd over
unsecured HTTP connection. For example Man-in-the-Middle attack could
change kernel or initrd to another files, but digital signature
verification should notice that.


\subsection{How it was done}

Secudep boot media contains at least two public keys. One is for
digital signature verification, and one or more are for verifying
HTTPS connections. More public keys are loaded over HTTPS connection
while boot progresses.

Testing that these verifications works can be done by either omitting
the public key from Secudep boot media or serving wrong public key
from Secudep's HTTPS server.

\begin{table}[!ht]
  % Add some padding to the table cells:
  \def\arraystretch{1.1}%
  \begin{center}
    \begin{tabular}{| l | l | l |}
      \hline
      Attack against     & Protocol   & Defense                                        \\
      \hline
      Address resolution & DHCP       & Verification done in boot menu              \\
      Name resolution    & DNS        & Verification done in boot menu              \\
      Boot menu          & HTTPS (DS) & Certificate and digital signature verification \\
      Digital signatures & HTTPS      & Certificate verification                     \\
      Kernel and initrd  & HTTP (DS)  & Digital signature verification               \\
      Kickstart          & HTTPS      & Certificate verification                     \\
      Installation files & HTTP (DS)  & Operating system takes control               \\
      \hline
    \end{tabular}
    \caption{Attack and it's defense in various steps of
      installation. DS in table means Digital
      Signatures.\label{tab:attack_and_defence}}
  \end{center}
\end{table}

Table~\ref{tab:attack_and_defence} lists steps in boot process and
what verification is used in each step.

DHCP and DNS Man-in-the-Middle attacks can be detected when X.509
certificate verification fails and HTTP Man-in-the-Middle attacks can
be detected when code signing verification fails.


\begin{table}[!ht]
  % Add some padding to the table cells:
  \def\arraystretch{1.1}%
  \begin{center}
    \begin{tabular}{| l | l | l |}
      \hline
      File            & Used for                        & Where it's located   \\
      \hline
      DS certificate  & Verify digital signatures       & in bootable media    \\
      X.509 for HTTPS & Verify HTTPS connection(s)      & in bootable media    \\
      Boot menu DS    & Verify boot menu is not changed & File on HTTPS server \\
      Kernel DS       & Verify kernel is not changed    & File on HTTPS server \\
      Initrd DS       & Verify initrd is not changed    & File on HTTPS server \\
      \hline
    \end{tabular}
    \caption{Different files used for verification in various steps,
      where they are used and where they are located. DS in table
      means Digital Signatures.\label{tab:verification_files}}
  \end{center}
\end{table}

Table~\ref{tab:verification_files} lists all files used for various
steps in process. Any failure in verification should halt the installation process.


\subsection{Results found}

\begin{table}[!ht]
  % Add some padding to the table cells:
  \def\arraystretch{1.1}%
  \begin{center}
    \begin{tabular}{| l | l | l |}
      \hline
      File            & Halts installation & iPXE error code \\
      \hline
      DS certificate  & True               & 0216eb3c        \\
      X.509 for HTTPS & True               & 0216eb3c        \\
      Boot menu DS    & True               & 0227e13c        \\
      Kernel DS       & True               & 0227e13c        \\
      Initrd DS       & True               & 0227e13c        \\
      \hline
    \end{tabular}
    \caption{Results of testing secudep's implementation by simulated
      attacks.\label{tab:mechanical_check_results}}
  \end{center}
\end{table}

Five different tests were made and results can be found from
table~\ref{tab:mechanical_check_results}. Every simulated attack was
noticed and the installation was halted. Table also gives iPXE's error
code for each tested case.


\subsection{Analysis of results}

Five different tests were made by breaking one verification step at a
time and trying to run the installation. The result was observed and
material collected.

\begin{figure}[h]
  \includegraphics[width=\textwidth]{verify-fail.png}
  \caption{Installation process is halted when digital signature
    verification fails.\label{fig:verify-fail}}
\end{figure}

Two distinct iPXE error codes were found while conducting the
tests. One example of such error is shown in
figure~\ref{fig:verify-fail}. In the figure the installation process
couldn't verify digital signature, and the process was halted and it
can't proceed further.

The first error code, ``0216eb3c'' is
documented\footnote{http://ipxe.org/err/0216eb3c} in iPXE web page as
``Error: No usable certificates''. This matches what was tested. In
the test a wrong certificate was provided so the error given is
correct.

The second error code ``0227e13c'' is
documented\footnote{http://ipxe.org/err/0227e13c} in iPXE web page as
``Error: RSA signature incorrect'' with additional notes stating

\begin{quote}
This error indicates that an RSA signature was found to be incorrect.

Things to try:

\begin{enumerate}
\item Check that all certificates are correct.
\item If you are verifying a digital signature using the imgverify
  command, check that you are using the correct signature file.
\end{enumerate}
\end{quote}

This matches what was tested. Either wrong RSA signature was given in
test or the file was changed so that the RSA signature verification
should fail.

This case study tested only the most obvious security issues. More
sophisticated attacks might exploit the implementation weaknesses in
iPXE and other software and hardware. Thus this case study is not
proof of perfect security, but shows that at least some cases of
attacks can be detected and reacted on.
